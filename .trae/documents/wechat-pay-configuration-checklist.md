# 微信支付配置快速检查清单

## 🔍 问题确认

你遇到的错误：`支付订单创建失败: 支付服务创建失败: The first argument must be of type string or an instance of Buffer` 表明微信支付配置不完整或配置错误。

## ✅ 配置前检查

### 1. 系统状态检查
- [ ] 后端服务正常运行
- [ ] 数据库连接正常
- [ ] 支付配置页面可访问：`http://localhost:4090/console/system-setting/payConfig`

### 2. 微信支付账号准备
- [ ] 已注册微信支付商户账号
- [ ] 已完成商户认证
- [ ] 已开通JSAPI支付产品

## 📝 配置步骤清单

### 步骤1：获取微信支付配置信息

#### 商户号 (MCHID)
- [ ] 登录 [微信商户平台](https://pay.weixin.qq.com)
- [ ] 进入"账户中心"→"账户信息"
- [ ] 记录"微信支付商户号"

#### APPID
- [ ] 登录 [微信开放平台](https://open.weixin.qq.com)
- [ ] 进入"管理中心"→"应用管理"
- [ ] 找到对应应用，记录APPID

#### API密钥
- [ ] 在微信商户平台进入"账户中心"→"API安全"
- [ ] 设置APIv3密钥（32位字符串）
- [ ] 安全保存密钥，**只能设置一次**

#### 支付证书
- [ ] 在商户平台"账户中心"→"API安全"
- [ ] 点击"申请证书"，按指引操作
- [ ] 下载证书文件（apiclient_cert.pem 和 apiclient_key.pem）
- [ ] 用文本编辑器打开证书文件，复制完整内容

### 步骤2：系统配置

#### 访问配置页面
- [ ] 打开系统管理后台
- [ ] 导航到：系统设置 → 支付配置
- [ ] 找到微信支付，点击"编辑"

#### 填写配置信息
- [ ] **显示名称**：微信支付（或自定义）
- [ ] **支付接口版本**：选择V3
- [ ] **商户类型**：选择普通商户
- [ ] **微信商户号**：粘贴MCHID
- [ ] **APPID**：粘贴应用ID
- [ ] **商户API密钥**：粘贴32位API密钥
- [ ] **微信支付证书**：粘贴apiclient_cert.pem完整内容
- [ ] **微信支付密钥**：粘贴apiclient_key.pem完整内容
- [ ] **排序**：设置为0或其他数值

#### 启用配置
- [ ] 开启"是否启用"开关
- [ ] 如需设为默认支付方式，开启"是否默认"
- [ ] 点击"更新"按钮保存配置

### 步骤3：验证配置

#### 配置验证
- [ ] 配置保存成功，无错误提示
- [ ] 支付配置列表显示微信支付状态为"启用"
- [ ] 数据库中payconfig表有对应记录

#### 支付测试
- [ ] 访问充值中心：`http://localhost:4090/profile/personal-rights/recharge-center`
- [ ] 选择充值套餐
- [ ] 选择微信支付方式
- [ ] 点击"立即购买"
- [ ] 观察是否成功创建支付订单

## 🚨 常见错误及解决方案

### 错误1：证书格式错误
**症状**：配置保存时报证书格式错误
**解决**：
- 确保证书包含`-----BEGIN CERTIFICATE-----`和`-----END CERTIFICATE-----`
- 检查证书内容完整，没有遗漏字符
- 确认复制的是.pem格式文件，不是其他格式

### 错误2：API密钥错误
**症状**：支付时提示签名错误
**解决**：
- 确认使用的是APIv3密钥，不是APIv2密钥
- 检查密钥长度是否为32位
- 重新在微信商户平台设置API密钥

### 错误3：商户号错误
**症状**：支付时提示商户号无效
**解决**：
- 确认使用的是微信支付商户号，不是微信公众号原始ID
- 检查商户号是否为纯数字

### 错误4：APPID不匹配
**症状**：支付时提示APPID不匹配
**解决**：
- 确认APPID与商户号已绑定
- 检查APPID是否为18位字符串

## 🔧 本地测试方案

### 方案A：使用微信沙箱环境（推荐）
1. 申请沙箱环境：微信商户平台→产品中心→开发配置
2. 使用沙箱商户号和密钥进行配置
3. 沙箱环境支持完整的支付流程测试

### 方案B：模拟支付流程
1. 在代码中添加测试接口，模拟支付回调
2. 手动触发订单状态更新
3. 验证业务逻辑是否正确

### 方案C：使用内网穿透
1. 安装ngrok等内网穿透工具
2. 将本地服务映射到公网域名
3. 配置真实的微信支付参数进行测试

## 📋 验证清单

配置完成后，请检查以下项目：

- [ ] 支付配置保存成功
- [ ] 充值页面能正常加载
- [ ] 选择套餐后显示正确价格
- [ ] 点击"立即购买"不再报错
- [ ] 能生成预支付订单
- [ ] 订单状态能正确更新
- [ ] 用户算力能正确增加

## 🆘 故障排查

如果配置后仍然报错，请按以下步骤排查：

1. **查看错误日志**
   ```bash
   tail -f logs/app.log
   ```

2. **检查数据库配置**
   ```sql
   SELECT * FROM payconfig WHERE pay_type = 1;
   ```

3. **验证网络连接**
   - 确认服务器能访问微信支付API
   - 检查防火墙设置

4. **联系技术支持**
   如果以上步骤都无法解决问题，请联系微信支付技术支持。

## ⚠️ 安全提醒

1. **保护密钥信息**：不要将商户密钥、证书等提交到代码仓库
2. **定期更新**：定期更新API密钥和证书
3. **权限控制**：确保只有管理员能访问支付配置
4. **监控告警**：设置支付异常监控和告警

完成以上配置后，你的微信支付功能应该能正常工作。如果仍有问题，请提供具体的错误信息以便进一步排查。