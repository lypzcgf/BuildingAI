# 微信支付测试完整解决方案

## 问题分析

根据错误信息和代码分析，点击"立即购买"按钮报错的原因是微信支付配置不完整。错误信息显示：`支付订单创建失败: 支付服务创建失败: The first argument must be of type string or an instance of Buffer`。

## 1. 微信支付配置步骤

### 1.1 登录微信支付配置页面
1. 访问系统管理后台：`http://localhost:4090/console/system-setting/payConfig`
2. 找到微信支付配置项，点击"编辑"按钮

### 1.2 配置必需参数

在支付配置表单中填写以下信息：

| 配置项 | 说明 | 获取方式 |
|--------|------|----------|
| **微信商户号** | 微信支付的商户号(MCHID) | 登录[微信商户平台](https://pay.weixin.qq.com)查看 |
| **APPID** | 应用ID | 微信开放平台申请的应用ID |
| **商户API密钥** | 商户API密钥 | 在商户平台设置 |
| **微信支付证书** | apiclient_cert.pem | 在商户平台生成并下载 |
| **微信支付密钥** | apiclient_key.pem | 在商户平台生成并下载 |
| **支付接口版本** | 选择V3 | 目前只支持V3版本 |
| **商户类型** | 选择普通商户 | 目前只支持普通商户 |

### 1.3 获取微信支付配置信息

#### 获取商户号(MCHID)
1. 登录[微信商户平台](https://pay.weixin.qq.com)
2. 在"账户中心"→"账户信息"中查看"微信支付商户号"

#### 获取APPID
1. 登录[微信开放平台](https://open.weixin.qq.com)
2. 在"管理中心"→"应用管理"中找到对应应用的APPID

#### 设置API密钥
1. 登录微信商户平台
2. 进入"账户中心"→"API安全"
3. 设置APIv3密钥（32位字符串）

#### 生成并下载证书
1. 在微信商户平台"账户中心"→"API安全"
2. 点击"申请证书"，按照指引生成证书
3. 下载证书文件（apiclient_cert.pem和apiclient_key.pem）
4. 将证书内容复制粘贴到配置表单中

## 2. 本地环境测试方法

### 2.1 使用微信沙箱环境

由于本地环境无法直接接收微信支付的异步通知，建议使用以下方案：

#### 方案一：使用内网穿透工具
1. 安装内网穿透工具（如ngrok、frp等）
2. 启动穿透服务，将本地端口映射到公网
3. 在支付配置中设置回调URL为穿透后的地址

```bash
# 使用ngrok示例（需先注册账号）
ngrok http 4090
```

#### 方案二：使用微信沙箱测试环境
1. 在微信商户平台申请沙箱环境
2. 使用沙箱环境的商户号和密钥进行测试
3. 沙箱环境支持模拟支付流程

### 2.2 测试支付流程

1. **配置完成后重启服务**
   ```bash
   # 重启后端服务
   npm run dev
   ```

2. **测试支付步骤**
   - 访问充值中心页面
   - 选择充值套餐（如1000算力 ¥10.00）
   - 选择微信支付方式
   - 点击"立即购买"
   - 系统应该能成功创建支付订单

3. **验证支付结果**
   - 查看数据库中的订单状态
   - 检查支付回调是否正确处理
   - 确认用户算力是否正确增加

## 3. 常见错误排查

### 3.1 配置错误

**错误：证书格式错误**
- 确保证书内容包含完整的BEGIN和END标记
- 检查证书内容是否完整，没有遗漏字符

**错误：API密钥错误**
- 确认使用的是APIv3密钥，不是APIv2密钥
- 检查密钥长度是否为32位

**错误：商户号错误**
- 确认使用的是微信支付商户号，不是微信公众号的原始ID

### 3.2 网络问题

**错误：无法连接微信支付服务器**
- 检查服务器是否能访问外网
- 确认防火墙没有阻止443端口
- 检查DNS解析是否正常

### 3.3 回调问题

**错误：支付成功但订单状态未更新**
- 检查回调URL是否能正常访问
- 确认回调处理逻辑是否正确
- 查看服务器日志确认是否收到回调

## 4. 沙箱环境使用说明

### 4.1 申请沙箱环境

1. 登录[微信商户平台](https://pay.weixin.qq.com)
2. 进入"产品中心"→"开发配置"
3. 申请开通沙箱环境

### 4.2 沙箱环境配置

在系统配置中使用沙箱环境的参数：
- 商户号：使用沙箱商户号
- API密钥：使用沙箱API密钥
- 证书：使用沙箱证书

### 4.3 沙箱测试专用接口

沙箱环境提供了专用的测试接口：
- 统一下单接口：`https://api.mch.weixin.qq.com/sandboxnew/pay/unifiedorder`
- 查询订单接口：`https://api.mch.weixin.qq.com/sandboxnew/pay/orderquery`

## 5. 支付回调测试方案

### 5.1 本地回调测试

由于微信支付需要公网IP才能发送回调，本地测试可以采用以下方法：

#### 方法一：手动模拟回调
1. 在代码中添加测试接口，手动触发回调处理
2. 使用Postman等工具模拟微信回调请求
3. 验证回调处理逻辑是否正确

#### 方法二：使用测试工具
1. 使用微信提供的[支付验收工具](https://pay.weixin.qq.com/wiki/doc/api/micropay.php?chapter=23_1)
2. 模拟各种支付场景和回调情况

### 5.2 回调验证要点

1. **签名验证**：确保回调请求的签名正确
2. **订单状态**：验证订单状态是否正确更新
3. **用户权益**：确认用户算力是否正确增加
4. **日志记录**：记录完整的回调处理日志

## 6. 调试技巧

### 6.1 日志查看

查看后端日志获取详细的错误信息：
```bash
# 查看实时日志
tail -f logs/app.log
```

### 6.2 数据库检查

检查支付相关表的数据：
```sql
-- 查看支付配置
SELECT * FROM payconfig;

-- 查看订单状态
SELECT * FROM recharge_order ORDER BY created_at DESC;
```

### 6.3 接口测试

使用curl测试支付接口：
```bash
curl -X POST http://localhost:3000/api/pay/prepay \
  -H "Content-Type: application/json" \
  -d '{
    "packageId": "套餐ID",
    "from": "recharge"
  }'
```

## 7. 安全注意事项

1. **保护密钥**：不要将商户密钥、证书等敏感信息提交到代码仓库
2. **权限控制**：确保支付配置页面只有管理员可以访问
3. **输入验证**：对所有支付参数进行严格的输入验证
4. **日志脱敏**：在日志中脱敏处理敏感信息

## 8. 测试数据

### 8.1 测试套餐
确保系统中有可用的充值套餐：
```sql
-- 检查套餐数据
SELECT * FROM recharge_package WHERE is_enable = 1;
```

### 8.2 测试用户
使用测试用户进行支付测试，避免影响真实用户数据。

通过以上步骤，你应该能够成功配置和测试微信支付功能。如果仍然遇到问题，请检查服务器日志获取详细的错误信息，并根据错误信息进行相应的调整。